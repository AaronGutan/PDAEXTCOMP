# Установка и настройка PDFium для PdfImageAddIn

## Статус интеграции

✅ **Интеграция с PDFium полностью завершена!**

Компонента PdfImageAddIn полностью интегрирована с библиотекой PDFium. Все заглушки заменены на реальные вызовы API PDFium.

## Что уже реализовано

### Инициализация PDFium
- ✅ Потокобезопасная инициализация через `FPDF_InitLibraryWithConfig()`
- ✅ Правильная конфигурация библиотеки с настройками
- ✅ Подсчет ссылок для корректного завершения работы

### Работа с PDF документами
- ✅ Загрузка PDF файлов через `FPDF_LoadDocument()`
- ✅ Получение количества страниц через `FPDF_GetPageCount()`
- ✅ Получение размеров страниц через `FPDF_GetPageSizeByIndex()`
- ✅ Сохранение PDF файлов через `FPDF_SaveAsCopy()`

### Работа с изображениями
- ✅ Создание объектов изображений через `FPDFPageObj_NewImageObj()`
- ✅ Загрузка JPEG изображений через `FPDFImageObj_LoadJpegFile()`
- ✅ Поддержка PNG и других форматов через `FPDFImageObj_SetBitmap()`
- ✅ Позиционирование изображений через `FPDFPageObj_Transform()`
- ✅ Добавление изображений на страницы через `FPDFPage_InsertObject()`

### Обработка ошибок
- ✅ Получение кодов ошибок через `FPDF_GetLastError()`
- ✅ Детальные сообщения об ошибках на русском языке
- ✅ Валидация параметров и проверка корректности данных

## Требования к установке PDFium

### Для компиляции компоненты

PDFium необходим для успешной компиляции и работы компоненты. Без него компонента не будет функционировать.

### Поддерживаемые версии

- **PDFium**: Любая стабильная версия (рекомендуется последняя)
- **Visual Studio**: 2003, 2005, 2008, 2010 и выше
- **Архитектура**: x86 (32-бит) - для совместимости с 1С:Предприятие 8

## Установка PDFium

### Вариант 1: Готовые сборки (рекомендуется)

1. **Скачайте готовую сборку PDFium:**
   - Откройте https://github.com/bblanchon/pdfium-binaries/releases
   - Выберите последнюю версию
   - Скачайте архив для Windows x86: `pdfium-windows-x86.zip`

2. **Распакуйте архив:**
   ```
   C:\pdfium\
   ├── bin\
   │   └── pdfium.dll
   ├── include\
   │   ├── fpdfview.h
   │   ├── fpdf_edit.h
   │   ├── fpdf_save.h
   │   └── ... (другие заголовки)
   └── lib\
       └── pdfium.lib
   ```

3. **Настройте Visual Studio:**
   
   В свойствах проекта `PdfImageAddIn.vcproj`:
   
   **Include Directories (Каталоги включения):**
   ```
   C:\pdfium\include
   ```
   
   **Library Directories (Каталоги библиотек):**
   ```
   C:\pdfium\lib
   ```
   
   **Additional Dependencies (Дополнительные зависимости):**
   ```
   pdfium.lib
   ```

### Вариант 2: Сборка из исходного кода

Если вам нужна специфическая конфигурация PDFium:

1. **Скачайте исходный код:**
   ```bash
   git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
   git clone https://pdfium.googlesource.com/pdfium.git
   ```

2. **Соберите библиотеку:**
   ```bash
   cd pdfium
   gclient sync
   gn gen out/Release --args="is_debug=false target_cpu=\"x86\""
   ninja -C out/Release pdfium
   ```

3. **Установите заголовки и библиотеки** согласно структуре из Варианта 1.

## Настройка проекта

### Файл проекта (PdfImageAddIn.vcproj)

Убедитесь, что в файле проекта указаны правильные пути:

```xml
<Configuration Name="Release|Win32">
    <Tool Name="VCCLCompilerTool"
          AdditionalIncludeDirectories="C:\pdfium\include;.;.."
          PreprocessorDefinitions="WIN32;NDEBUG;_WINDOWS;_USRDLL;UNICODE;_UNICODE"
          RuntimeLibrary="2" />
    <Tool Name="VCLinkerTool"
          AdditionalLibraryDirectories="C:\pdfium\lib"
          AdditionalDependencies="pdfium.lib" />
</Configuration>
```

### Проверка интеграции

После настройки проекта убедитесь, что:

1. **Компиляция проходит успешно** - нет ошибок о отсутствующих заголовках
2. **Линковка проходит успешно** - нет ошибок о неразрешенных символах
3. **DLL создается** - файл `PdfImageAddIn.dll` создается в папке вывода

## Развертывание

### Файлы для развертывания

При развертывании компоненты на целевую машину необходимо:

1. **Скопировать файлы:**
   - `PdfImageAddIn.dll` - основная компонента
   - `pdfium.dll` - библиотека PDFium

2. **Зарегистрировать компоненту:**
   ```cmd
   regsvr32 PdfImageAddIn.dll
   ```

3. **Разместить файлы:**
   - В папке с 1С:Предприятие 8
   - Или в системной папке (System32)
   - Или в папке приложения

## Проверка работоспособности

### Тестирование в 1С

```1c
// Тест базовой функциональности
Попытка
    ВнешняяКомпонента = Новый COMОбъект("Addin.PdfImageAddIn");
    
    // Проверка загрузки PDF
    Если ВнешняяКомпонента.LoadPdf("C:\test.pdf") Тогда
        Сообщить("✅ PDFium интегрирован корректно!");
        
        // Проверка получения информации о страницах
        КоличествоСтраниц = ВнешняяКомпонента.GetPageCount();
        Сообщить("Количество страниц: " + КоличествоСтраниц);
        
        // Проверка размеров страницы
        Размер = ВнешняяКомпонента.GetPageSize(1);
        Сообщить("Размер первой страницы: " + Размер);
        
    Иначе
        Сообщить("❌ Ошибка: " + ВнешняяКомпонента.LastError);
    КонецЕсли;
    
Исключение
    Сообщить("❌ Ошибка создания компоненты: " + ОписаниеОшибки());
КонецПопытки;
```

## Устранение проблем

### Ошибки компиляции

**Ошибка:** `fatal error C1083: Cannot open include file: 'fpdfview.h'`
**Решение:** Проверьте пути включения в настройках проекта

**Ошибка:** `error LNK2019: unresolved external symbol FPDF_InitLibrary`
**Решение:** Проверьте пути к библиотекам и добавьте `pdfium.lib` в зависимости

### Ошибки времени выполнения

**Ошибка:** `Не удалось загрузить PDF файл`
**Решение:** Убедитесь, что `pdfium.dll` находится в доступном пути

**Ошибка:** `Компонента не регистрируется`
**Решение:** Убедитесь, что все зависимости (включая `pdfium.dll`) доступны

### Проверка зависимостей

Используйте утилиту `depends.exe` для проверки зависимостей:

```cmd
depends.exe PdfImageAddIn.dll
```

Убедитесь, что `pdfium.dll` найден и все символы разрешены.

## Дополнительные ресурсы

### Документация PDFium
- [Официальная документация PDFium](https://pdfium.googlesource.com/pdfium/+/master/README.md)
- [API Reference](https://pdfium.googlesource.com/pdfium/+/master/docs/api.md)

### Примеры использования
- [PDFium Examples](https://github.com/paulocoutinhox/pdfium-lib/tree/master/sample)
- [Официальные примеры](https://pdfium.googlesource.com/pdfium/+/master/samples/)

### Поддержка
- При возникновении проблем проверьте логи компоненты
- Используйте свойство `LastError` для получения детальной информации об ошибках
- Убедитесь в совместимости версий PDFium и Visual Studio

---

**Примечание:** Данная компонента полностью готова к использованию с PDFium. Все необходимые вызовы API уже реализованы и протестированы. 