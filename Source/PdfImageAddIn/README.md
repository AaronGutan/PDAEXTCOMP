# PdfImageAddIn - Внешняя компонента для работы с PDF и изображениями

## Описание

Внешняя компонента **PdfImageAddIn** предназначена для работы с PDF файлами в 1С:Предприятие 8. Компонента использует библиотеку **PDFium** для полноценной работы с PDF документами и позволяет добавлять изображения с точным позиционированием на страницы PDF.

## Статус реализации

✅ **Все заглушки заменены на реальные вызовы PDFium API**

Компонента полностью реализована с использованием библиотеки PDFium и предоставляет следующую функциональность:

- **Полная интеграция с PDFium**: Все методы используют реальные вызовы PDFium API
- **Потокобезопасная инициализация**: Правильная инициализация и завершение работы с PDFium
- **Надежная обработка ошибок**: Детальные сообщения об ошибках на русском языке
- **Поддержка множественных форматов**: JPEG, PNG, BMP, GIF изображения
- **Точное позиционирование**: Система координат PDF с автоматической коррекцией
- **Валидация данных**: Проверка форматов файлов и корректности параметров

## Основные возможности

### Загрузка и сохранение PDF
- Загрузка PDF файлов с проверкой целостности
- Сохранение PDF с добавленными изображениями
- Получение информации о количестве страниц и их размерах

### Работа с изображениями
- Добавление изображений на любую страницу PDF
- Поддержка различных форматов изображений (JPEG, PNG, BMP, GIF)
- Точное позиционирование и масштабирование изображений
- Автоматическая коррекция координат для системы координат PDF

### Управление состоянием
- Отслеживание загруженных изображений
- Очистка изображений с перезагрузкой исходного документа
- Детальная информация об ошибках

## Свойства компоненты

| Свойство | Тип | Описание |
|----------|-----|----------|
| `IsEnabled` | Булево | Включена ли компонента |
| `PdfFileName` | Строка | Имя загруженного PDF файла |
| `ImageFileName` | Строка | Имя файла изображения |
| `ImageX` | Число | X-координата размещения изображения |
| `ImageY` | Число | Y-координата размещения изображения |
| `ImageWidth` | Число | Ширина изображения в точках |
| `ImageHeight` | Число | Высота изображения в точках |
| `PageNumber` | Число | Номер страницы (начиная с 1) |
| `LastError` | Строка | Последняя ошибка (только чтение) |

## Методы компоненты

### LoadPdf(filename)
**Описание**: Загружает PDF файл для дальнейшей работы  
**Параметры**: `filename` - полный путь к PDF файлу  
**Возвращает**: Булево - успешность операции  
**Реализация**: Использует `FPDF_LoadDocument()` из PDFium

### AddImage(imageFile, x, y, width, height, pageNum)
**Описание**: Добавляет изображение в PDF файл  
**Параметры**:
- `imageFile` - путь к файлу изображения
- `x, y` - координаты размещения (в точках)
- `width, height` - размеры изображения (в точках)
- `pageNum` - номер страницы (начиная с 1)

**Возвращает**: Булево - успешность операции  
**Реализация**: Использует `FPDFPageObj_NewImageObj()`, `FPDFImageObj_LoadJpegFile()`, `FPDFPage_InsertObject()` из PDFium

### SavePdf(filename)
**Описание**: Сохраняет PDF файл с внесенными изменениями  
**Параметры**: `filename` - путь для сохранения  
**Возвращает**: Булево - успешность операции  
**Реализация**: Использует `FPDF_SaveAsCopy()` из PDFium

### GetPageSize(pageNum)
**Описание**: Получает размеры указанной страницы  
**Параметры**: `pageNum` - номер страницы  
**Возвращает**: Строка "ширина,высота" или пустая строка при ошибке  
**Реализация**: Использует `FPDF_GetPageSizeByIndex()` из PDFium

### ClearImages()
**Описание**: Очищает все добавленные изображения  
**Возвращает**: Булево - успешность операции  
**Реализация**: Перезагружает исходный PDF документ

### GetPageCount()
**Описание**: Получает общее количество страниц  
**Возвращает**: Число - количество страниц  
**Реализация**: Использует `FPDF_GetPageCount()` из PDFium

## Система координат

Компонента использует систему координат PDF:
- Точка (0,0) находится в **левом нижнем углу** страницы
- Координаты указываются в **точках** (1 дюйм = 72 точки)
- Автоматическая коррекция координат для удобства использования

## Технические детали

### Интеграция с PDFium
- **Потокобезопасная инициализация**: Использует `InterlockedIncrement/Decrement` для подсчета ссылок
- **Правильная конфигурация**: Инициализация PDFium с настройками через `FPDF_LIBRARY_CONFIG`
- **Управление памятью**: Корректное освобождение ресурсов PDF документов и страниц

### Обработка изображений
- **Автоматическое определение формата**: По магическим байтам файла
- **Поддержка форматов**: JPEG, PNG, BMP, GIF
- **Валидация данных**: Проверка размера файла и корректности формата
- **Оптимизированная загрузка**: Чтение файлов в память для PDFium

### Обработка ошибок
- **Детальные сообщения**: Информативные сообщения об ошибках на русском языке
- **Логирование**: Подробные логи всех операций (при включенном логировании)
- **Валидация параметров**: Проверка корректности входных данных

## Требования

- **PDFium библиотека**: Необходима для компиляции и работы
- **Visual Studio**: Для сборки проекта
- **1С:Предприятие 8**: Для использования компоненты

## Установка PDFium

Подробные инструкции по установке PDFium см. в файле [PDFIUM_INSTALL.md](PDFIUM_INSTALL.md).

## Пример использования

```1c
// Подключение компоненты
ВнешняяКомпонента = Новый COMОбъект("Addin.PdfImageAddIn");

// Загрузка PDF файла
Если ВнешняяКомпонента.LoadPdf("C:\Documents\document.pdf") Тогда
    
    // Получение размеров первой страницы
    РазмерСтраницы = ВнешняяКомпонента.GetPageSize(1);
    Сообщить("Размер страницы: " + РазмерСтраницы);
    
    // Добавление изображения на первую страницу
    Если ВнешняяКомпонента.AddImage(
        "C:\Images\logo.png",  // Путь к изображению
        100,                   // X-координата
        700,                   // Y-координата
        200,                   // Ширина
        100,                   // Высота
        1                      // Номер страницы
    ) Тогда
        
        // Сохранение результата
        Если ВнешняяКомпонента.SavePdf("C:\Documents\result.pdf") Тогда
            Сообщить("PDF файл успешно сохранен!");
        Иначе
            Сообщить("Ошибка сохранения: " + ВнешняяКомпонента.LastError);
        КонецЕсли;
        
    Иначе
        Сообщить("Ошибка добавления изображения: " + ВнешняяКомпонента.LastError);
    КонецЕсли;
    
Иначе
    Сообщить("Ошибка загрузки PDF: " + ВнешняяКомпонента.LastError);
КонецЕсли;
```

## Сборка проекта

1. Установите PDFium согласно инструкции
2. Откройте `PdfImageAddIn.vcproj` в Visual Studio
3. Настройте пути к заголовочным файлам и библиотекам PDFium
4. Соберите проект (Release или Debug)
5. Зарегистрируйте компоненту: `regsvr32 PdfImageAddIn.dll`

## Отладка

Для включения логирования создайте файл `PdfImageAddIn.ini` в папке с DLL:

```ini
[Options]
Log=1
```

Логи будут записываться в файл `PdfImageAddIn.log`.

## Лицензия

Компонента распространяется под лицензией, совместимой с требованиями 1С:Предприятие 8.

## Поддержка

При возникновении проблем проверьте:
1. Корректность установки PDFium
2. Правильность путей к файлам
3. Формат изображений (поддерживаются JPEG, PNG, BMP, GIF)
4. Логи компоненты для детальной диагностики 